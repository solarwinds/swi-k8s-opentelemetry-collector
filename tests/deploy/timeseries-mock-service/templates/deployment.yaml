apiVersion: apps/v1
kind: Deployment
metadata:
  name: timeseries-mock-service
spec:
  replicas: 1
  selector:
    matchLabels:
      app: timeseries-mock-service
  template:
    metadata:
      labels:
        app: timeseries-mock-service
    spec:
      securityContext:
        runAsUser: 0
      nodeSelector:
        kubernetes.io/os: linux
{{- if .Values.clickhouse.enabled }}
      initContainers:
        - name: wait-for-clickhouse
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              echo "Waiting for ClickHouse to be ready..."
              until wget -q --spider http://clickhouse:8123/ping; do
                echo "ClickHouse is not ready yet, waiting..."
                sleep 2
              done
              echo "ClickHouse is ready!"
{{- end }}
      containers:
        - name: opentelemetry-collector
          command:
            - /otelcol-contrib
            - --config=/conf/relay.yaml
          securityContext:
            runAsUser: 0
          image: {{ .Values.otel.image }}
          imagePullPolicy: IfNotPresent
          env:
            - name: GOMEMLIMIT
              valueFrom:
                resourceFieldRef:
                  resource: limits.memory
          ports:
            - name: otlp
              containerPort: 9082
              protocol: TCP
            - name: metrics
              containerPort: 8080
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "512Mi"
              cpu: "500m"
          livenessProbe:
            httpGet:
              path: /
              port: 13133
            initialDelaySeconds: 15
            periodSeconds: 10
            timeoutSeconds: 5
          readinessProbe:
            httpGet:
              path: /
              port: 13133
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
          volumeMounts:
            - mountPath: /conf
              name: opentelemetry-collector-configmap
{{- if .Values.fileProvider.enabled }}
            - name: output
              mountPath: /data
{{- end }}
{{- if .Values.fileProvider.enabled }}
        - name: file-provider
          image: {{ .Values.fileProvider.image }}
          command: ['sh', '-c', 'touch /usr/share/nginx/html/events.json && touch /usr/share/nginx/html/metrics.json && touch /usr/share/nginx/html/logs.json && touch /usr/share/nginx/html/manifests.json && touch /usr/share/nginx/html/traces.json && touch /usr/share/nginx/html/entitystateevents.json && chmod -R 777 /usr/share/nginx/html && nginx -g "daemon off;"']
          securityContext:
            runAsUser: 0
          volumeMounts:
          - name: output
            mountPath: /usr/share/nginx/html
          ports:
          - name: html
            containerPort: 80
{{- end }}
      volumes:
        - name: opentelemetry-collector-configmap
          configMap:
            name: timeseries-mock-service-config
            items:
              - key: relay
                path: relay.yaml
{{- if .Values.fileProvider.enabled }}
        - name: output
          emptyDir: {}
{{- end }}
