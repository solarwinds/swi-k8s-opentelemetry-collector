# Loki configuration for integration testing
# Single-binary mode with minimal resource footprint

# Deploy Loki in single binary mode (no microservices)
deploymentMode: SingleBinary

loki:
  # Single binary configuration
  commonConfig:
    replication_factor: 1
  
  # Disable multi-tenancy for test environment (no authentication required)
  auth_enabled: false
  
  # Storage configuration - use filesystem for test simplicity
  storage:
    type: filesystem
  
  # Schema configuration
  schemaConfig:
    configs:
      - from: 2024-01-01
        store: tsdb
        object_store: filesystem
        schema: v13
        index:
          prefix: index_
          period: 24h
  
  # Retention configuration - 1 hour for test environment
  limits_config:
    retention_period: 1h
    max_query_length: 0h  # no limit on query time range
    max_query_lookback: 1h
    max_streams_per_user: 10000
    max_global_streams_per_user: 10000
    ingestion_rate_mb: 10
    ingestion_burst_size_mb: 20
    per_stream_rate_limit: 5MB
    per_stream_rate_limit_burst: 15MB
    allow_structured_metadata: true  # Required for OTLP ingestion
  
  # Compactor configuration for retention enforcement
  compactor:
    working_directory: /var/loki/compactor
    compaction_interval: 10m
    retention_enabled: true
    retention_delete_delay: 2m
    retention_delete_worker_count: 150
    delete_request_store: filesystem
  
  distributor:
    otlp_config:
      default_resource_attributes_as_index_labels:
        - otel.entity.event_as_log
        - otel.entity.event.type
        - otel.entity.type
        - otel.entity_relationship.type
        - k8s.cluster.name
        - k8s.container.name
        - k8s.cronjob.name
        - k8s.daemonset.name
        - k8s.deployment.name
        - k8s.job.name
        - k8s.namespace.name
        - k8s.pod.name
        - k8s.replicaset.name
        - k8s.statefulset.name
        - k8s.node.name

  # Storage configuration
  storage_config:
    filesystem:
      directory: /var/loki/chunks
    tsdb_shipper:
      active_index_directory: /var/loki/index
      cache_location: /var/loki/index_cache
  
  # Chunk configuration - optimized for short retention
  chunk_store_config:
    chunk_cache_config:
      enable_fifocache: true
      fifocache:
        max_size_bytes: 104857600  # 100MB
        ttl: 1h

# Single binary pod configuration
singleBinary:
  replicas: 1
  
  # Resource limits - minimal for test environment
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi
  
  # Persistence for chunks and index
  persistence:
    enabled: true
    size: 1Gi
    storageClass: null  # use default storage class
  
  # Extra environment variables
  extraEnv:
    - name: GOMEMLIMIT
      valueFrom:
        resourceFieldRef:
          resource: limits.memory

# Gateway configuration - disabled for test simplicity
gateway:
  enabled: false

# Monitoring configuration
monitoring:
  serviceMonitor:
    enabled: false
  selfMonitoring:
    enabled: false
    grafanaAgent:
      installOperator: false

# Test configuration
test:
  enabled: false

# Backend configuration - using filesystem
backend:
  replicas: 0

# Read/Write split disabled (single binary mode)
read:
  replicas: 0

write:
  replicas: 0

chunksCache:
  enabled: false

resultsCache:
  enabled: false