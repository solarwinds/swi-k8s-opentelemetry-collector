name: Check for Issue number
permissions:
    contents: read
    pull-requests: read

on:
    pull_request:
        types:
            - opened
            - edited
            - synchronize

    workflow_dispatch:

jobs:
    check_pr_branch:
        runs-on: ubuntu-latest
        steps:
            - name: Issue number in PR title
              env:
                  PR_TITLE: ${{ github.event.pull_request.title }}
              run: |
                  ISSUE_NUMBER=$(echo "$PR_TITLE" | grep -oE '^([[:alpha:]]+-[[:digit:]]+)[-_\:/[:space:]]' || echo "")
                  if [ -n "$ISSUE_NUMBER" ]; then
                      echo "::error::Pull Request title must not include an issue number"
                      exit 1
                  fi
            - name: Issue number in branch name
              env:
                  BRANCH_NAME: ${{ github.event.pull_request.head.ref }}
              run: |
                  ISSUE_NUMBER=$(echo "$BRANCH_NAME" | grep -oE '^([[:alpha:]]+-[[:digit:]]+)[-_\:/[:space:]]' || echo "")
                  if [ -n "$ISSUE_NUMBER" ]; then
                      echo "::error::Branch name must not include an issue number"
                      exit 1
                  fi

    check_commit_messages:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
            - name: Issue number in commit
              run: |
                  set -o pipefail

                  BASE="${{ github.event.pull_request.base.sha }}"
                  HEAD="${{ github.event.pull_request.head.sha }}"

                  # Get SHA||subject for all non-merge commits in the PR range
                  git log --no-merges --pretty=format:'%H||%s' "$BASE..$HEAD" > commits.txt || true

                  bad=0
                  while IFS='||' read -r sha subject; do
                      # Skip empty lines (e.g., no commits or merge-only ranges)
                      [ -z "$sha" ] && continue

                      if echo "$subject" | grep -qE '^([[:alpha:]]+-[[:digit:]]+)[-_\:/[:space:]]'; then
                          echo "::error sha=$sha::Commit must not include issue key. Found in: $subject"
                          bad=1
                      fi
                  done < commits.txt

                  exit $bad
