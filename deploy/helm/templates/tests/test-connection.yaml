apiVersion: v1
kind: Pod
metadata:
  name: {{ include "common.fullname" (tuple . "-test-connection") }}
  annotations:
    "helm.sh/hook": test
spec:
  containers:
  - name: otel-endpoint-check
    image: "{{ include "common.image" (tuple . .Values.otel "image" nil .Chart.AppVersion) }}"
    imagePullPolicy: {{ .Values.otel.image.pullPolicy }}
    command:
      - /swi-otelcol
      - test-connection
      - --endpoint=$(OTEL_ENVOY_ADDRESS)
      - --apitoken=$(SOLARWINDS_API_TOKEN)
      - --clusteruid=$(CLUSTER_UID)
      - --insecure=$(OTEL_ENVOY_ADDRESS_TLS_INSECURE)
    env:
      - name: SOLARWINDS_API_TOKEN
        valueFrom:
          secretKeyRef:
            name: {{ template "common.secret" . }}
            key: SOLARWINDS_API_TOKEN
            optional: true
    envFrom:
      - configMapRef:
          name: {{ include "common.fullname" (tuple . "-common-env") }}
  restartPolicy: Never
